using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections;
using UnityEngine.SceneManagement;

public class WinSceneController : MonoBehaviour
{
    [Header("Backgrounds")]
    public Sprite secondBackground; // ??????? ??????? (???????? ?? ????)

    [Header("UI Elements")]
    public Image fadeImage;
    public Image backgroundImage;  // ??? ????? ????? ?????? (??????? ??????)
    public GameObject textBoxContainer;
    public TextMeshProUGUI winText;
    public GameObject mainMenuButton;

    [Header("Text Settings")]
    [TextArea(3, 10)]
    public string fullText = "aaaaaaaaaaaaaaaaaaaaa";
    public float typingSpeed = 0.05f;

    [Header("Timing")]
    public float pauseAfterText = 2f;      // ???? ??? ?????? ???????
    public float pauseBeforeFinal = 0.5f;  // ???? ??? ????? ???????

    private void Start()
    {
        // ??????? ???????
        textBoxContainer.SetActive(true);  // ????? ????? ?????? ?? ???????
        mainMenuButton.SetActive(false);
        winText.text = "";  // ???? ????
        fadeImage.color = new Color(0, 0, 0, 1); // ???? ????? ???????

        // backgroundImage ????? ??? ????? ?????? (??????? ??????) ?? ??? Inspector
        // ?? ???? ??? ???

        // ?????? ?? ?? FadeImage ?? ???????
        fadeImage.transform.SetAsLastSibling();

        StartCoroutine(PlayWinSequence());
    }

    IEnumerator PlayWinSequence()
    {
        // 1. ????? ?? (???? ????? ??????)
        yield return StartCoroutine(Fade(0));

        // 2. ??? ????? ???? ??? ???
        foreach (char c in fullText.ToCharArray())
        {
            winText.text += c;
            yield return new WaitForSeconds(typingSpeed);
        }

        yield return new WaitForSeconds(pauseAfterText);

        // 3. ????? ??? (???????? ??????)
        yield return StartCoroutine(Fade(1));

        // 4. ????? ?????? ??????? (??? ?????? ??????)
        textBoxContainer.SetActive(false);           // ????? ????? ????
        backgroundImage.sprite = secondBackground;   // ????? ??????? ???????
        mainMenuButton.SetActive(true);              // ????? ???? (????? ??????)

        yield return new WaitForSeconds(pauseBeforeFinal);

        // 5. ????? ?? ?????? (???? ??????? ??????? ?? ????)
        yield return StartCoroutine(Fade(0));
    }

    IEnumerator Fade(float targetAlpha)
    {
        float duration = 1f;
        float startAlpha = fadeImage.color.a;
        float timer = 0;

        while (timer < duration)
        {
            timer += Time.deltaTime;
            float newAlpha = Mathf.Lerp(startAlpha, targetAlpha, timer / duration);
            fadeImage.color = new Color(0, 0, 0, newAlpha);
            yield return null;
        }

        fadeImage.color = new Color(0, 0, 0, targetAlpha);
    }

    public void GoToMainMenu()
    {
        SceneManager.LoadScene("MainMenu");
    }
}